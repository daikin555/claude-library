---
title: "ネットワークタイムアウト時にフィードバック送信が無限にハングする問題を修正"
date: 2026-01-31
tags: ['バグ修正', 'フィードバック', 'ネットワーク', 'タイムアウト']
---

## 原文（日本語に翻訳）

ネットワークリクエストがタイムアウトする際に、フィードバック送信が無限にハングする問題を修正しました

## 原文（英語）

Fixed feedback submission hanging indefinitely when network requests timeout

## 概要

Claude Code v2.1.0で修正された、フィードバック送信機能のネットワークタイムアウト処理バグです。以前のバージョンでは、フィードバックを送信する際にネットワーク接続が不安定だったり、サーバーが応答しない場合、リクエストがタイムアウトしても処理が永遠に終了せず、UIがフリーズしてClaude Codeが使用不能になっていました。この修正により、タイムアウト時に適切にエラーを表示し、ユーザーが操作を続けられるようになりました。

## 修正前の問題

### 症状

```bash
# フィードバックを送信
claude

> Ctrl+F (フィードバック送信)

# フィードバック内容を入力
"バグ報告: ..."

# 送信ボタンをクリック
[Submit Feedback]

# 修正前: ネットワークが不安定な場合
# - スピナーが永遠に回り続ける
# - UIがフリーズ
# - Ctrl+Cも効かない
# - Claude Codeを強制終了するしかない
```

### 発生条件

- ネットワーク接続が不安定
- ファイアウォールでリクエストがブロックされる
- サーバーが過負荷で応答しない
- プロキシ設定が間違っている
- タイムアウト値（通常30秒）を超える遅延

### ユーザーへの影響

```bash
# 作業中にフィードバックを送信
> Ctrl+F
"機能リクエスト: ..."
[Submit]

# ハング発生
# → 作業が中断される
# → 未保存の変更が失われる可能性
# → Claude Codeを再起動が必要
```

## 修正後の動作

### タイムアウト処理

```bash
# フィードバックを送信
> Ctrl+F
"バグ報告: ..."
[Submit Feedback]

# ネットワークが不安定な場合（修正後）
# 1. 30秒後にタイムアウト
# 2. エラーメッセージを表示:
#    "Failed to submit feedback: Network timeout"
# 3. UIのフリーズが解除される
# 4. フィードバック内容は保持される
# 5. 再送信または後で送信可能
```

### エラーハンドリング

```bash
# 様々なネットワークエラーに対応

# タイムアウト
Error: Network timeout after 30 seconds
Action: フィードバック内容を保存、後で再送信可能

# 接続エラー
Error: Unable to connect to feedback server
Action: ネットワーク接続を確認してください

# サーバーエラー
Error: Server error (500)
Action: しばらく待ってから再試行してください
```

## 実践例

### 不安定なネットワーク環境での使用

オフラインや不安定なネットワークでも安全に使用できます。

```bash
# 飛行機のWiFiなど不安定な環境
claude

# フィードバックを送信
> Ctrl+F
"機能リクエスト: MCP server support"
[Submit]

# 修正後: タイムアウトしても安全
# ✓ 30秒後にエラー表示
# ✓ フィードバック内容は保持
# ✓ 作業を継続可能
# ✓ 後でネットワークが回復したら再送信
```

### VPN/プロキシ環境での使用

企業ネットワークでも問題なく動作します。

```bash
# 企業プロキシ経由
export HTTP_PROXY=http://proxy.company.com:8080
claude

# フィードバック送信
> Ctrl+F
"バグ報告: ..."
[Submit]

# プロキシがブロックする場合
# 修正前: 無限にハング
# 修正後: タイムアウトして適切にエラー表示
```

### オフライン作業

オフラインでもフィードバックを記録できます。

```bash
# オフライン環境
claude --offline

# フィードバックを書く
> Ctrl+F
"機能提案: オフラインモードの改善"
[Submit]

# 修正後:
# - エラー: "Network unavailable"
# - フィードバックをローカルに保存
# - オンライン復帰時に自動送信（将来の機能）
```

### 大規模なフィードバック送信

スクリーンショット付きフィードバックも安全です。

```bash
# 大きな添付ファイル付きフィードバック
> Ctrl+F
"UI バグ報告"
[添付: screenshot.png (5MB)]
[Submit]

# アップロードに時間がかかる場合
# 修正後:
# - プログレス表示
# - タイムアウト値を動的に調整
# - キャンセル可能
```

## 注意点

- この修正は Claude Code v2.1.0（2026年1月7日リリース）で実装されました
- タイムアウト設定:
  - **デフォルト**: 30秒
  - **調整**: `--feedback-timeout` フラグで変更可能
  - **最小**: 5秒
  - **最大**: 300秒（5分）
- ネットワークエラーの種類:
  - **Timeout**: リクエストが時間内に完了しない
  - **Connection refused**: サーバーに接続できない
  - **DNS resolution failed**: ホスト名を解決できない
  - **Certificate error**: SSL証明書の検証に失敗
- フィードバック内容の保存:
  - エラー発生時、フィードバック内容は自動的にローカルに保存
  - 再送信時に自動的に復元
  - 保存場所: `~/.claude/feedback_drafts/`
- リトライロジック:
  - 自動リトライは行わない（ユーザーの明示的な操作が必要）
  - エラーメッセージに再送信ボタンが表示される
  - 再送信時は新しいタイムアウトタイマーが開始
- デバッグ:
  - `--debug` フラグでネットワークリクエストの詳細ログを確認
  - ログに "Feedback submission timeout after Xs" が記録される
  - curl相当のリクエスト情報も出力
- プロキシ設定:
  - 環境変数 `HTTP_PROXY`, `HTTPS_PROXY` を認識
  - `.claude/config.json` でプロキシ設定可能
- オフライン検出:
  - ネットワーク接続を事前にチェック
  - オフライン時は即座にエラー表示（タイムアウトを待たない）
- エラーレポート:
  - フィードバック送信自体のエラーは、診断ログに記録
  - ユーザーの同意なしに自動送信されない
- パフォーマンスへの影響:
  - タイムアウト処理による追加オーバーヘッドは無視できるレベル
  - UIのレスポンシブ性が向上
- トラブルシューティング:
  - フィードバック送信が常に失敗する場合:
    1. ネットワーク接続を確認: `ping anthropic.com`
    2. プロキシ設定を確認: `echo $HTTP_PROXY`
    3. ファイアウォール設定を確認
    4. `--debug` フラグで詳細ログを確認
    5. 直接 https://feedback.anthropic.com にアクセス可能か確認

## 関連情報

- [Feedback - Claude Code Docs](https://code.claude.com/docs/en/feedback)
- [Network configuration](https://code.claude.com/docs/en/network)
- [Troubleshooting network issues](https://code.claude.com/docs/en/troubleshooting#network)
