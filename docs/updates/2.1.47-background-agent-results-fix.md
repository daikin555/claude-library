---
title: "バックグラウンドエージェントの結果が生のトランスクリプトデータで返される問題を修正"
date: 2026-02-19
tags: [bug-fix, agents, background, output]
---

## 原文（日本語に翻訳）

バックグラウンドエージェントの結果がエージェントの最終回答ではなく生のトランスクリプトデータを返す問題を修正しました（anthropics/claude-code#26012）。

## 原文（英語）
Fixed background agent results returning raw transcript data instead of the agent's final answer (anthropics/claude-code#26012)

## 概要

バックグラウンドエージェントのタスクが完了した際、結果として人間が読みやすい最終回答ではなく、内部的なトランスクリプトのJSONデータが返されるバグが修正されました。ユーザーには読みにくい大量の内部データが表示されていました。修正後はエージェントが生成した整形された最終回答が正しく返されます。

## 基本的な使い方

```bash
# バックグラウンドエージェントを起動
claude --background "src/ 以下のコードをレビューして問題点を報告して"

# タスク完了後に結果を確認
claude --result <session-id>

# 修正前の出力（生のトランスクリプトデータ）:
# {"messages":[{"role":"user","content":"src/ 以下の..."},
#  {"role":"assistant","content":[{"type":"text","text":"..."},
#  {"type":"tool_use","id":"toolu_xxx","name":"Read",...}]},
#  ... (大量のJSONデータ)],"usage":{"input_tokens":...}}

# 修正後の出力（整形された最終回答）:
# コードレビューの結果:
#
# 1. src/auth.ts: 型定義が不完全です。UserId型を追加してください。
# 2. src/api.ts: エラーハンドリングが不足しています。
# 3. src/utils.ts: 未使用のインポートが3箇所あります。
```

## 実践例

### ユースケース1: 非同期コードレビューの結果取得

バックグラウンドでコードレビューを実行して後から結果を確認する場合。

```bash
# コードレビューをバックグラウンドで依頼
claude --background "プルリクエストの変更をレビューして改善点をまとめて"
# Session ID: bg-session-abc123

# 別の作業をしながら待機
# ...

# レビュー完了後に結果を確認
claude --result bg-session-abc123

# 修正後の出力（読みやすい形式）:
# ## コードレビュー結果
#
# ### 重要な問題
# - `src/api.ts:45`: SQLインジェクションの脆弱性の可能性
# - `src/auth.ts:12`: パスワードが平文で保存されています
#
# ### 改善提案
# - `src/utils.ts`: 関数を小さく分割することを推奨
# - テストカバレッジが67%。最低80%を推奨
#
# ### 良い点
# - エラーハンドリングが一貫している
# - コメントが適切に付いている
```

### ユースケース2: 長時間タスクの結果収集

データ分析など時間のかかるタスクをバックグラウンドで実行する場合。

```bash
# データ分析タスクをバックグラウンドで依頼
claude --background "logs/ ディレクトリの全ログを分析してエラーパターンを特定して"
# Session ID: bg-session-def456

# 数分後に結果を確認
claude --result bg-session-def456

# 修正後の出力:
# ## ログ分析レポート
#
# 分析期間: 2026-01-01 〜 2026-02-19
# 総ログ件数: 1,234,567 行
#
# ### エラーパターン
# 1. `ConnectionTimeout` - 1,234件 (毎日14:00-15:00に集中)
# 2. `OutOfMemoryError` - 456件 (大規模バッチ処理時に発生)
# 3. `NullPointerException` - 89件 (ユーザー入力処理で発生)
#
# ### 推奨対処
# 1. タイムアウト設定を30秒から60秒に延長
# 2. バッチサイズを1000から500に縮小
```

### ユースケース3: 複数バックグラウンドタスクの結果まとめ

複数のバックグラウンドエージェントの結果を順次確認する場合。

```bash
# 複数タスクを並列でバックグラウンド実行
claude --background "フロントエンドのパフォーマンスを分析して"
# Session ID: bg-fe-001

claude --background "バックエンドのAPIレスポンスタイムを分析して"
# Session ID: bg-be-002

claude --background "データベースのクエリ効率を分析して"
# Session ID: bg-db-003

# すべて完了後に結果を確認
claude --result bg-fe-001
# → フロントエンド分析の整形されたレポートが表示される

claude --result bg-be-002
# → バックエンド分析の整形されたレポートが表示される

claude --result bg-db-003
# → DB分析の整形されたレポートが表示される
```

## 注意点

- この修正以前は、バックグラウンドエージェントの結果をプログラムで処理しようとした際に誤ってJSONを解析していた場合、修正後は動作が変わる可能性があります
- バックグラウンドエージェントの生のトランスクリプトデータが必要な場合は、別途APIを通じてアクセスする方法を検討してください
- 修正はすべてのバックグラウンドエージェントタスクに適用されます
- セッションIDはバックグラウンドエージェント起動時に表示されるため、必ず記録しておいてください

## 関連情報

- [Claude Code 公式ドキュメント](https://docs.anthropic.com/ja/docs/claude-code/overview)
- [CHANGELOG.md](https://github.com/anthropics/claude-code/blob/main/CHANGELOG.md)
- [GitHub Issue #26012](https://github.com/anthropics/claude-code/issues/26012)
- [Claude Code バックグラウンドエージェントガイド](https://docs.anthropic.com/ja/docs/claude-code/sub-agents)
