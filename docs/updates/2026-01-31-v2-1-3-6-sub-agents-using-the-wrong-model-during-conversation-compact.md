---
title: "会話圧縮時のサブエージェントモデル選択エラーを修正"
date: 2026-01-09
tags: ['バグ修正', 'サブエージェント', 'モデル選択', 'パフォーマンス']
---

## 原文（日本語に翻訳）

会話の圧縮処理中にサブエージェントが誤ったモデルを使用する問題を修正しました

## 原文（英語）

Fixed sub-agents using the wrong model during conversation compaction

## 概要

Claude Code v2.1.3では、会話履歴が長くなり圧縮（compaction）が行われる際に、サブエージェントが意図したものとは異なるモデルを使用してしまう問題が修正されました。これにより、タスク実行時に指定したモデルが一貫して使用され、期待通りのパフォーマンスと品質が保たれるようになります。

## 基本的な使い方

サブエージェントは、複雑なタスクを自律的に処理するために使用されます。

```bash
# サブエージェントを使用したタスクの実行例
# 明示的なモデル指定（例：Haiku for fast tasks）
# v2.1.3では、長い会話でも指定したモデルが維持される
```

## 実践例

### 修正前の問題

長時間の会話や複雑なタスクで会話圧縮が発生すると、モデルが切り替わってしまうことがありました。

```bash
# 修正前の動作例
# 1. Haikuモデルを指定してサブエージェントを起動
#    - 高速な処理を期待
# 2. 会話が長くなり、圧縮処理が実行される
# 3. 圧縮後、意図せずSonnetモデルに切り替わる
#    - パフォーマンスが低下（意図しない動作）
#    - コストが増加する可能性
```

### 修正後の動作

v2.1.3では、会話圧縮後もモデル選択が保持されます。

```bash
# 修正後の動作例
# 1. Haikuモデルを指定してサブエージェントを起動
#    - 高速な処理を期待
# 2. 会話が長くなり、圧縮処理が実行される
# 3. 圧縮後もHaikuモデルが維持される✅
#    - 一貫したパフォーマンス
#    - 予測可能なコスト
```

### 長時間タスクでのモデル選択

複雑なプロジェクトで複数のサブエージェントを使い分ける場合の例です。

```bash
# ユースケース：大規模プロジェクトの分析と実装
# 1. 探索タスク（Explore agent with Haiku）
#    - 高速にコードベースを調査
#    - 圧縮後もHaikuを使用（コスト効率的）

# 2. 計画タスク（Plan agent with Sonnet）
#    - 詳細な実装計画を作成
#    - 圧縮後もSonnetを使用（高品質維持）

# 3. 実装タスク（General-purpose agent with Sonnet）
#    - コード生成と修正
#    - 圧縮後もSonnetを使用（品質保証）
```

### 会話圧縮のトリガー

会話圧縮は以下のような状況で発生します。

```bash
# 会話圧縮が発生するケース
# - 会話のトークン数が一定の閾値を超えた場合
# - 長時間の対話セッション
# - 複雑なタスクで多数のツール呼び出しがある場合

# v2.1.3以降は、どのケースでもモデル選択が保持される
```

## 注意点

- この修正は自動的に適用され、ユーザー側での設定変更は不要です
- サブエージェントのモデル選択は、タスクの性質に応じて適切に設定することを推奨します
  - 単純なタスク：Haiku（高速・低コスト）
  - 複雑なタスク：Sonnet（高品質）
- 会話圧縮はバックグラウンドで自動的に行われ、通常は気づかない処理です
- モデルの一貫性が重要な場合は、v2.1.3へのアップデートを強く推奨します

## 関連情報

- [Claude Code 公式ドキュメント](https://claude.ai/code)
- [Changelog v2.1.3](https://github.com/anthropics/claude-code/releases/tag/v2.1.3)
- [サブエージェントの使い方](https://github.com/anthropics/claude-code)
- [モデル選択のベストプラクティス](https://github.com/anthropics/claude-code)
