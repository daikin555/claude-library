---
title: "APIプロキシの404エラー時の非ストリーミングフォールバックを修正"
date: 2026-02-06
tags: [api, proxy, bugfix]
---

## 原文（日本語に翻訳）

APIプロキシで404エラーが発生した際の非ストリーミングフォールバックを修正しました。

## 原文（英語）

Fixed API proxy 404 non-streaming fallback

## 概要

プロキシ経由でClaude APIを利用する際、404エラーが発生した場合の非ストリーミングモードへのフォールバック処理が正しく動作していなかった問題が修正されました。これにより、プロキシ環境でもより安定した動作が期待できます。

## 基本的な使い方

プロキシ設定を行っている環境で、自動的にフォールバックが機能します。

```bash
# プロキシ環境変数の設定
export HTTP_PROXY=http://proxy.example.com:8080
export HTTPS_PROXY=http://proxy.example.com:8080

claude
```

## 実践例

### 企業プロキシ環境での使用

企業のプロキシサーバー経由でClaude Codeを使用する場合。

```bash
# プロキシ設定
export HTTP_PROXY=http://corporate-proxy.company.com:3128
export HTTPS_PROXY=http://corporate-proxy.company.com:3128

# プロキシ認証が必要な場合
export HTTP_PROXY=http://username:password@proxy.company.com:3128

claude
# ストリーミングエラー時に自動的に非ストリーミングモードにフォールバック
```

### プロキシ除外設定

特定のホストをプロキシから除外する場合。

```bash
# NO_PROXY設定
export NO_PROXY=localhost,127.0.0.1,.local

# プロキシ設定
export HTTP_PROXY=http://proxy.example.com:8080
export HTTPS_PROXY=http://proxy.example.com:8080

claude
```

### DNSリゾルバー設定

プロキシでDNS解決を行う場合。

```bash
# プロキシ側でDNS解決を行う
export CLAUDE_CODE_PROXY_RESOLVES_HOSTS=true

# プロキシ設定
export HTTP_PROXY=http://proxy.example.com:8080

claude
```

## 注意点

- プロキシ環境では `HTTP_PROXY` と `HTTPS_PROXY` 環境変数を設定します
- プロキシ認証が必要な場合、URL内にユーザー名とパスワードを含めます
- `NO_PROXY` で特定のホストをプロキシから除外できます
- プロキシDNS解決は `CLAUDE_CODE_PROXY_RESOLVES_HOSTS=true` で有効化します（デフォルトはオプトイン）
- 404エラー時のフォールバック処理により、接続の信頼性が向上しました

## 関連情報

- [プロキシ設定ガイド](https://code.claude.com/docs/en/troubleshooting)
- [企業環境での使用](https://code.claude.com/docs/en/enterprise)
