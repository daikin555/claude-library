---
title: "プロンプトキャッシュヒット率の改善 - システムプロンプトからの日付移動"
date: 2026-02-13
tags: [performance, cache, optimization, api]
---

## 原文（日本語）
システムプロンプトから日付を移動することでプロンプトキャッシュヒット率を改善しました。

## 原文（英語）
Improved prompt cache hit rates by moving date out of system prompt

## 概要
Claude Code v2.1.42では、システムプロンプトの構造を最適化し、日付情報を別の場所に移動することで、プロンプトキャッシュの再利用率が大幅に向上しました。これにより、API呼び出しのコストが削減され、応答速度も改善されます。

## プロンプトキャッシングとは

Claude APIは、繰り返し使用される長いプロンプトをキャッシュすることで、処理時間とコストを削減する機能を提供しています。キャッシュが再利用できる（キャッシュヒット）と、以下のメリットがあります：

- レスポンス時間の短縮
- API利用料金の削減（キャッシュされたトークンは低価格）

## この改善の仕組み

### 従来の問題点
以前は、システムプロンプトに現在の日付が含まれていたため、日付が変わるたびにプロンプト全体が新しいものと見なされ、キャッシュが無効化されていました。

```text
# 従来の構造（簡略化）
System Prompt:
- Claude Codeの動作指示
- 現在の日付: 2026-02-13  ← 毎日変わる
- その他の設定
```

### 改善後
日付情報をシステムプロンプトから分離することで、システムプロンプトの本体は変更されず、キャッシュが有効活用されます。

```text
# 改善後の構造
System Prompt:
- Claude Codeの動作指示
- その他の設定
（日付は別の場所で提供）
```

## ユーザーへの影響

### より高速な応答
特に以下のような場面で効果を実感できます：

#### 同じプロジェクトでの連続作業
```bash
# 同じプロジェクトで複数のタスクを実行
claude
> ファイルAを修正してください
> 次にファイルBも更新してください
```

各リクエストでキャッシュが再利用されるため、応答が速くなります。

#### 長時間のセッション
1日を通じて同じプロジェクトで作業する場合、システムプロンプトのキャッシュが維持されるため、一貫して高速な応答が得られます。

### コスト削減
Claude APIを使用している場合、プロンプトキャッシュのヒット率向上により、以下のようなコスト削減効果があります：

- キャッシュされたトークンは通常のトークンより90%安価
- 長いシステムプロンプトが毎回キャッシュから読み込まれる

## 最大限に活用するためのヒント

### セッションの継続
可能な限り、同じClaude Codeセッションを継続して使用することで、キャッシュの恩恵を最大化できます。

### 一貫した作業環境
同じプロジェクトディレクトリ、同じ設定で作業を続けることで、キャッシュヒット率が向上します。

## 注意点
- この改善は自動的に適用され、ユーザー側での設定変更は不要です
- プロンプトキャッシングはClaude APIの機能であり、ローカル処理には影響しません
- 機能面での変更はなく、応答内容の品質は変わりません

## 関連情報
- [Claude APIドキュメント - Prompt Caching](https://docs.anthropic.com/claude/docs/prompt-caching)
- [Claude Code公式リポジトリ](https://github.com/anthropics/claude-code)
- [プロンプトキャッシングのベストプラクティス](https://docs.anthropic.com/claude/docs/prompt-caching-best-practices)
