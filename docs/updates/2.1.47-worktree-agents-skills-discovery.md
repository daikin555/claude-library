---
title: "git worktreeからカスタムエージェントとスキルが検出されない問題の修正"
date: 2026-02-19
tags: [bug-fix, agents, skills, worktree, git, discovery]
---

## 原文（日本語に翻訳）

git worktreeから実行した場合にカスタムエージェントとスキルが検出されない問題を修正しました — メインリポジトリのプロジェクトレベルの `.claude/agents/` と `.claude/skills/` が含まれるようになりました（anthropics/claude-code#25816）

## 原文（英語）
Fixed custom agents and skills not being discovered when running from a git worktree — project-level `.claude/agents/` and `.claude/skills/` from the main repository are now included (anthropics/claude-code#25816)

## 概要

git worktreeを使用して作業ディレクトリを切り替えた場合、メインリポジトリの `.claude/agents/` および `.claude/skills/` ディレクトリに定義されたカスタムエージェントやスキルが検出されない問題がありました。この修正により、worktreeディレクトリから起動した場合でも、メインリポジトリのカスタムエージェントとスキルが利用可能になります。

## 基本的な使い方

git worktreeとカスタムエージェント・スキルを組み合わせて使用する場合。

```bash
# メインリポジトリの構造
# main-repo/
# ├── .claude/
# │   ├── agents/
# │   │   └── code-reviewer.md
# │   └── skills/
# │       └── translate.md
# └── src/

# worktreeを作成
git worktree add ../main-repo-feature feature-branch

# worktreeディレクトリに移動
cd ../main-repo-feature

# Claude Codeを起動
claude
# 修正後: メインリポジトリの agents/ と skills/ が利用可能
# 修正前: worktreeからは検出されなかった
```

## 実践例

### ユースケース1: フィーチャーブランチでのカスタムエージェント利用

メインブランチで定義したコードレビューエージェントをworktreeのフィーチャーブランチで使用する場合。

```bash
# メインリポジトリにエージェントを定義
cat main-repo/.claude/agents/code-reviewer.md
```

```markdown
---
name: code-reviewer
description: "プロジェクト固有のコードレビューエージェント"
model: claude-opus-4-6
---

あなたはこのプロジェクトのコーディング規約に詳しいコードレビュアーです。
以下の点を重点的にチェックしてください：
- TypeScriptの型安全性
- テストカバレッジ
- パフォーマンスの考慮
```

```bash
# フィーチャーブランチのworktreeで作業
cd main-repo-feature

# カスタムエージェントが利用可能（修正後）
claude
> @code-reviewer このプルリクエストのコードをレビューしてください
# → メインリポジトリの code-reviewer エージェントが使用される
```

### ユースケース2: 複数のworktreeで共通スキルを使用

メインリポジトリのスキルを複数のworktreeで共有する場合。

```bash
# メインリポジトリにスキルを定義
cat main-repo/.claude/skills/generate-docs.md
```

```markdown
---
name: generate-docs
description: "このプロジェクト向けのドキュメント生成スキル"
argument-hint: "component-name"
---

指定されたコンポーネントのAPIドキュメントを生成してください。
このプロジェクトのJSDocスタイルに従って記述してください。
```

```bash
# 複数のworktreeで同じスキルを使用
# worktree 1: フィーチャーA
cd main-repo-feature-a
claude
> /generate-docs UserAuthentication
# → メインリポジトリのスキルが使用される（修正後）

# worktree 2: フィーチャーB
cd main-repo-feature-b
claude
> /generate-docs PaymentProcessor
# → 同じスキルが使用される（修正後）
```

### ユースケース3: worktreeの構造確認

カスタムエージェントとスキルがどこから検出されるかを確認する。

```bash
# メインリポジトリの構造確認
ls main-repo/.claude/
# agents/  skills/  settings.json

ls main-repo/.claude/agents/
# code-reviewer.md  deployment-assistant.md

ls main-repo/.claude/skills/
# generate-docs.md  translate.md

# worktreeに移動してClaude Codeを起動
cd main-repo-feature
claude

# 利用可能なエージェントの確認
> /agents
# 表示される:
# - code-reviewer (メインリポジトリから)
# - deployment-assistant (メインリポジトリから)

# 利用可能なスキルの確認
> /skills
# 表示される:
# - generate-docs (メインリポジトリから)
# - translate (メインリポジトリから)
```

## 注意点

- この修正はgit worktreeを使用している場合に適用されます。通常のクローンには影響しません。
- worktreeディレクトリに独自の `.claude/agents/` や `.claude/skills/` を配置することも引き続き可能です。その場合はメインリポジトリのものとマージされます。
- 同名のエージェントやスキルが存在する場合、worktreeのものがメインリポジトリのものより優先されます。
- メインリポジトリのパスはgitの内部情報から自動的に検出されます。
- git worktreeはgit 2.5以降でサポートされています。

## 関連情報

- [Claude Code 公式ドキュメント](https://docs.anthropic.com/ja/docs/claude-code/overview)
- [Claude Code CHANGELOG](https://github.com/anthropics/claude-code/blob/main/CHANGELOG.md)
- [GitHub Issue #25816](https://github.com/anthropics/claude-code/issues/25816)
- [Git Worktree ドキュメント](https://git-scm.com/docs/git-worktree)
- [カスタムエージェントの作成](https://docs.anthropic.com/ja/docs/claude-code/overview)
- [カスタムスキルの作成](https://docs.anthropic.com/ja/docs/claude-code/overview)
