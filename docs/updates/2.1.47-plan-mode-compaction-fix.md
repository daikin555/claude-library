---
title: "コンテキスト圧縮後にプランモードが失われる問題の修正"
date: 2026-02-19
tags: [bug-fix, plan-mode, context-compaction, workflow]
---

## 原文（日本語に翻訳）

コンテキスト圧縮後にプランモードが失われ、モデルが計画モードから実装モードに切り替わってしまう問題を修正しました（anthropics/claude-code#26061）

## 原文（英語）
Fixed plan mode being lost after context compaction, causing the model to switch from planning to implementation mode (anthropics/claude-code#26061)

## 概要

Claude Codeのプランモードは、コードを直接変更せずに計画のみを立案するモードです。長いセッションでコンテキスト圧縮が発生した際に、プランモードの状態が失われ、モデルが意図せず実装を開始してしまう問題がありました。この修正により、コンテキスト圧縮後もプランモードの状態が正しく保持されるようになります。

## 基本的な使い方

プランモードを有効にしてClaude Codeを使用します。

```bash
# プランモードで起動
claude --plan

# または設定ファイルでデフォルト有効化
# settings.json に以下を追加:
# { "planMode": true }
```

修正後は、長時間のセッションでコンテキスト圧縮が発生しても、プランモードが維持されます。

## 実践例

### ユースケース1: 大規模リファクタリングの計画

長いコードベースのリファクタリング計画を立てる際、コンテキスト圧縮が発生しても計画モードを維持できます。

```bash
# プランモードで起動
claude --plan

> このプロジェクト全体のアーキテクチャをマイクロサービス構成に
> 移行するための詳細な計画を立ててください。
# → Claudeは計画のみを提案し、コードは変更しない

# セッションが長くなりコンテキスト圧縮が発生しても...
# 修正後: 引き続きプランモードで動作（コードは変更しない）
# 修正前: プランモードが失われ、コードを変更し始めていた
```

### ユースケース2: プランの承認フロー

プランモードで計画を確認してから実装に移行するワークフロー。

```bash
# Step 1: プランモードで計画を立案
claude --plan

> 認証システムをJWTベースに変更する計画を立ててください
# Claudeが詳細な実装計画を提示（コードは変更しない）

# コンテキスト圧縮が発生（長いセッションの場合）
# 修正後: プランモードが維持される

> 続けて、データベース層の計画も立ててください
# 引き続き計画モードで動作

# Step 2: 計画を確認後、プランモードを解除して実装
# Ctrl+C でセッション終了後、--plan なしで再起動
claude
> 先ほど計画した認証システムの変更を実装してください
```

### ユースケース3: チームレビュー用の計画作成

実装前にチームにレビューしてもらうための計画ドキュメント作成。

```bash
claude --plan

> 以下の機能追加の実装計画を作成してください：
> 1. ユーザープロフィール編集機能
> 2. 画像アップロード機能
> 3. SNS連携機能
>
> 各機能の影響範囲、必要な変更ファイル、工数見積もりも含めてください
```

## 注意点

- プランモードはコードを直接変更しないため、計画の確認が完了するまで安全に利用できます。
- コンテキスト圧縮は長いセッションで自動的に発生します。この修正により、圧縮後もプランモードが維持されます。
- プランモードを明示的に解除するには、セッションを終了して `--plan` フラグなしで再起動します。
- `settings.json` で `planMode: true` を設定している場合も、この修正の恩恵を受けます。
- プランモードでもファイルの読み取りや情報収集は行われます（書き込みのみが制限されます）。

## 関連情報

- [Claude Code 公式ドキュメント](https://docs.anthropic.com/ja/docs/claude-code/overview)
- [Claude Code CHANGELOG](https://github.com/anthropics/claude-code/blob/main/CHANGELOG.md)
- [GitHub Issue #26061](https://github.com/anthropics/claude-code/issues/26061)
- [コンテキスト管理について](https://docs.anthropic.com/ja/docs/claude-code/overview)
