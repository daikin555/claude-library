---
title: "プロンプトサジェスチョンキャッシュのヒット率低下バグを修正"
date: 2026-02-22
tags: [bug-fix, performance, cache]
---

## 原文（日本語に翻訳）

キャッシュヒット率を低下させていたプロンプトサジェスチョンキャッシュのリグレッションを修正しました。

## 原文（英語）

Fixed prompt suggestion cache regression that reduced cache hit rates.

## 概要

プロンプトサジェスチョン（入力補完候補）のキャッシュが正しく機能せず、ヒット率が低下していたリグレッションバグが修正されました。この修正により、以前のバージョンで意図的に実装されたキャッシュ効率が回復し、APIコスト削減とレスポンス速度の向上が期待できます。

## 基本的な使い方

この修正はバックグラウンドで自動的に適用されます。ユーザーが特別な操作を行う必要はありません。

```bash
# 通常どおりClaudeを使用するだけでキャッシュが正しく機能します
claude "コードをレビューしてください"
```

## 実践例

### ユースケース1: 長いシステムプロンプトを繰り返し使用する場合

```bash
# システムプロンプトが長い場合、キャッシュが効果的に機能します
# 以前: キャッシュミスが多く、毎回フルトークンを消費
# 修正後: キャッシュヒットによりトークン消費を抑制

claude --system "あなたはPythonの専門家です..." "関数を最適化してください"
# → キャッシュが正しく機能し、2回目以降のリクエストが高速化
```

### ユースケース2: 同じコンテキストで連続して質問する場合

```bash
# 同一セッション内で繰り返し類似のリクエストを送る場合
# キャッシュヒット率が向上し、レスポンスが安定化
claude "このファイルを分析して"
# → コンテキストがキャッシュされ、後続のリクエストが効率化
```

### ユースケース3: CI/CDパイプラインでの繰り返し実行

```bash
# 自動化パイプラインで同じプロンプトパターンを繰り返す場合
for file in *.py; do
  claude "このファイルのコードレビューをしてください: $file"
done
# → 共通のプレフィックスがキャッシュされ、コスト効率が向上
```

## 注意点

- このバグは特定のバージョンで発生したリグレッションであり、修正により従来のキャッシュ動作に戻っています。
- プロンプトキャッシュの効果はプロンプトの内容や長さによって異なります。
- Anthropic APIのプロンプトキャッシュ機能と連携しており、繰り返しの多いワークフローで特に効果的です。

## 関連情報

- [Claude Code 公式ドキュメント](https://docs.anthropic.com/ja/docs/claude-code/overview)
- [Claude Code CHANGELOG](https://github.com/anthropics/claude-code/blob/main/CHANGELOG.md)
- [Anthropic プロンプトキャッシュドキュメント](https://docs.anthropic.com/ja/docs/build-with-claude/prompt-caching)
