---
title: "キャッシュヒット率を低下させていたプロンプト提案キャッシュのリグレッションを修正しました"
date: 2026-02-21
tags: [bug-fix, performance, cache]
---

## 原文（日本語に翻訳）

キャッシュヒット率を低下させていたプロンプト提案キャッシュのリグレッションを修正しました。

## 原文（英語）

Fixed prompt suggestion cache regression that reduced cache hit rates

## 概要

プロンプト提案（入力補完候補）のキャッシュが正しく機能せず、キャッシュヒット率が低下していた問題が修正されました。この問題により、同様のプロンプトを入力した際にキャッシュが利用されずに毎回新たにキャッシュが生成されていました。修正後はキャッシュが正しく再利用され、プロンプト提案の応答速度が改善されます。

## 基本的な使い方

この修正は自動的に適用されます。プロンプト入力時の補完候補表示が改善されます。

```bash
# Claude Codeを起動してプロンプトを入力
claude

# プロンプト提案（補完）が表示される
> git...
# → 「git add」「git commit」「git push」などの提案が表示
# → v2.1.50以降: キャッシュが正しく機能し応答が改善

> ファイルを...
# → 「ファイルを読んで」「ファイルを修正して」などの提案
# → キャッシュが再利用されスムーズに表示
```

## 実践例

### ユースケース1: 繰り返し使用するコマンドでのキャッシュ恩恵

よく使うコマンドや定型的なプロンプトを入力する場合。

```bash
claude

# 最初の入力: キャッシュ生成
> テストを実行して結果を報告して

# 類似のプロンプト: キャッシュが再利用される
> テストを実行して失敗原因を特定して
# → 修正後: キャッシュが機能し提案がスムーズに表示
```

### ユースケース2: 長いセッションでの継続的な使用

長いセッションで多数のプロンプトを入力する場合。

```bash
# 長時間セッション中のプロンプト入力
claude

# 最初の数回: キャッシュが構築される
> コードを...     # キャッシュ生成
> ファイルを...   # キャッシュ生成
> テストを...     # キャッシュ生成

# 以降の入力: キャッシュが再利用される
> コードを修正して  # キャッシュヒット → スムーズな提案
> ファイルを読んで  # キャッシュヒット → スムーズな提案
```

### ユースケース3: API/ヘッドレスモードでのキャッシュ恩恵

`ANTHROPIC_API_KEY` を設定してAPIを使用する場合（プロンプトキャッシングの恩恵）。

```bash
# APIキャッシュと組み合わせた効率的な実行
export ANTHROPIC_API_KEY=your_api_key

# 同様のプロンプトを繰り返し使う場合のコスト削減
claude -p "このコードをレビューして"
claude -p "このコードをレビューして問題点を指摘して"
# → キャッシュが機能することで類似リクエストの処理が改善
```

## 注意点

- この修正はv2.1.49でも同様の修正（別のキャッシュリグレッション）が行われており、v2.1.50でさらに別のキャッシュ問題が修正されました。
- プロンプト提案キャッシュはセッション内で機能します。セッションをまたいでキャッシュは持続しません。
- キャッシュヒット率の改善による体感速度の向上はシステム環境によって異なります。
- この修正はAnthropicのAPIプロンプトキャッシング（有料機能）とは別の、ローカルキャッシュの問題です。

## 関連情報

- [Claude Code 公式ドキュメント](https://docs.anthropic.com/ja/docs/claude-code/overview)
- [Claude Code CHANGELOG](https://github.com/anthropics/claude-code/blob/main/CHANGELOG.md)
- [Anthropic プロンプトキャッシング](https://docs.anthropic.com/ja/docs/build-with-claude/prompt-caching)
