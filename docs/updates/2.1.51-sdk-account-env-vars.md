---
title: "SDKアカウント情報の環境変数による同期提供でテレメトリの競合状態を解消"
date: 2026-02-24
tags: [sdk, environment-variables, telemetry, account, organization]
---

## 原文（日本語に翻訳）

SDK呼び出し元がアカウント情報を同期的に提供するための `CLAUDE_CODE_ACCOUNT_UUID`、`CLAUDE_CODE_USER_EMAIL`、`CLAUDE_CODE_ORGANIZATION_UUID` 環境変数を追加しました。これにより、初期テレメトリイベントにアカウントメタデータが欠落する競合状態が解消されます。

## 原文（英語）

Added `CLAUDE_CODE_ACCOUNT_UUID`, `CLAUDE_CODE_USER_EMAIL`, and `CLAUDE_CODE_ORGANIZATION_UUID` environment variables for SDK callers to provide account info synchronously, eliminating a race condition where early telemetry events lacked account metadata.

## 概要

Claude Code SDKを利用するシステムが、アカウント情報（ユーザーID、メールアドレス、組織ID）を起動時に環境変数として提供できるようになりました。以前は、セッション開始直後のテレメトリイベントが非同期のアカウント情報ロードを待てずに、アカウントメタデータなしで送信されてしまう競合状態（レースコンディション）がありました。これらの環境変数を設定することで、セッション開始から正確なアカウント情報が付与されたテレメトリデータを収集できます。

## 基本的な使い方

```bash
# SDK呼び出し時にアカウント情報を環境変数として提供
export CLAUDE_CODE_ACCOUNT_UUID="xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx"
export CLAUDE_CODE_USER_EMAIL="user@example.com"
export CLAUDE_CODE_ORGANIZATION_UUID="yyyyyyyy-yyyy-yyyy-yyyy-yyyyyyyyyyyy"

claude
```

## 実践例

### OpenTelemetryでのテレメトリ収集

組織全体でClaude Codeの使用状況を監視する場合：

```bash
# 管理された設定ファイル（~/.claude/managed-settings.json）でのグローバル設定
{
  "env": {
    "CLAUDE_CODE_ENABLE_TELEMETRY": "1",
    "CLAUDE_CODE_ACCOUNT_UUID": "${USER_UUID}",
    "CLAUDE_CODE_USER_EMAIL": "${USER_EMAIL}",
    "CLAUDE_CODE_ORGANIZATION_UUID": "${ORG_UUID}",
    "OTEL_METRICS_EXPORTER": "otlp",
    "OTEL_LOGS_EXPORTER": "otlp",
    "OTEL_EXPORTER_OTLP_ENDPOINT": "https://otel-collector.company.internal:4318"
  }
}
```

### CI/CDパイプラインでの利用

GitHub Actionsでチーム別にテレメトリを集計：

```yaml
- name: Claude Codeでコードレビューを実行
  env:
    CLAUDE_CODE_ACCOUNT_UUID: ${{ secrets.CLAUDE_ACCOUNT_UUID }}
    CLAUDE_CODE_USER_EMAIL: ci-bot@company.com
    CLAUDE_CODE_ORGANIZATION_UUID: ${{ secrets.CLAUDE_ORG_UUID }}
    CLAUDE_CODE_ENABLE_TELEMETRY: "1"
    OTEL_EXPORTER_OTLP_ENDPOINT: ${{ secrets.OTEL_ENDPOINT }}
  run: |
    claude --print "コードのセキュリティ問題を分析してください"
```

### テレメトリデータの確認

環境変数が正しく設定されているか確認：

```bash
# 現在の設定を確認
echo "Account UUID: $CLAUDE_CODE_ACCOUNT_UUID"
echo "User Email: $CLAUDE_CODE_USER_EMAIL"
echo "Org UUID: $CLAUDE_CODE_ORGANIZATION_UUID"

# テレメトリが有効かどうか確認
echo "Telemetry: $CLAUDE_CODE_ENABLE_TELEMETRY"
```

### 利用可能なテレメトリ環境変数の全体像

```bash
# アカウント識別情報（v2.1.51で追加）
CLAUDE_CODE_ACCOUNT_UUID=         # ユーザーのアカウントUUID
CLAUDE_CODE_USER_EMAIL=           # ユーザーのメールアドレス
CLAUDE_CODE_ORGANIZATION_UUID=    # 組織のUUID

# テレメトリ有効化
CLAUDE_CODE_ENABLE_TELEMETRY=1    # テレメトリを有効化

# OpenTelemetry設定
OTEL_METRICS_EXPORTER=otlp       # メトリクスエクスポーター
OTEL_LOGS_EXPORTER=otlp          # ログエクスポーター
OTEL_EXPORTER_OTLP_ENDPOINT=     # OTLPエンドポイント
```

## 注意点

- これらの環境変数はSDK呼び出し元向けの機能です。通常のインタラクティブな使用では、Claude Codeが自動的にOAuthアカウント情報を読み込みます。
- `CLAUDE_CODE_USER_EMAIL` にはユーザーのメールアドレスが含まれます。プライバシーポリシーに従って適切に取り扱ってください。
- テレメトリはデフォルトでは無効です。`CLAUDE_CODE_ENABLE_TELEMETRY=1` を明示的に設定した場合のみ有効になります。
- 管理者は MDM（Mobile Device Management）を通じてこれらの設定を配布し、ユーザーが変更できないようにすることが可能です。

## 関連情報

- [Claude Code 使用状況監視ドキュメント](https://code.claude.com/docs/en/monitoring-usage)
- [Claude Code CHANGELOG](https://github.com/anthropics/claude-code/blob/main/CHANGELOG.md)
- [Claude Code + OpenTelemetry + Grafana ガイド](https://quesma.com/blog/track-claude-code-usage-and-limits-with-grafana-cloud/)
- [SigNoz: Claude Code Monitoring with OpenTelemetry](https://signoz.io/docs/claude-code-monitoring/)
