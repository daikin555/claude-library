---
title: "プロンプトキャッシングのレースコンディション修正"
date: 2026-01-29
tags: [bug-fix, performance, caching, stability]
---

## 原文（日本語訳）
プロンプトキャッシングスコープが有効な場合に 400 エラーを引き起こす可能性があったレースコンディションを修正しました

## 原文（英語）
Fixed a race condition that could cause 400 errors when prompt caching scope was enabled

## 概要
プロンプトキャッシング機能を使用している際に、タイミングの問題で API エラー（HTTP 400）が発生することがあった問題が修正されました。これにより、キャッシングが有効な状態でも安定して動作するようになります。

## 修正された問題

プロンプトキャッシングスコープ機能を有効にした際に、並行処理やツール呼び出しのタイミングによって以下のエラーが発生していました：

```
API Error: 400 - Bad Request
tool use concurrency issues
```

このエラーは、複数のツール呼び出しやサブエージェントが同時に実行されるときに発生しやすい問題でした。

## プロンプトキャッシングとは

プロンプトキャッシングは、同じコンテキストを繰り返し使用する際に API リクエストを高速化し、コストを削減する機能です。会話の履歴やプロジェクトのコンテキストがキャッシュされ、次回のリクエストで再利用されます。

## 注意点

- **安定性の向上**: この修正により、プロンプトキャッシング使用時の安定性が大幅に向上しました
- **並行処理**: 複数のツール呼び出しやサブエージェントを使用する場合でも、安全に動作します
- **自動有効化**: プロンプトキャッシングは自動的に有効化されます。特別な設定は不要です
- **キャッシュ分離**: 2026年2月5日以降、キャッシュはワークスペースレベルで分離されます
- **パフォーマンス**: レースコンディションの修正により、パフォーマンスへの影響はありません
- **エラーハンドリング**: 400 エラーが発生した場合は `/rewind` コマンドで会話を復旧できます

## トラブルシューティング

以前のバージョンで 400 エラーが発生した場合：

```bash
# 会話を巻き戻す
/rewind

# または新しい会話を開始
/clear
```

## 関連情報

- [Prompt Caching - Claude API Docs](https://platform.claude.com/docs/en/build-with-claude/prompt-caching)
- [How to Use Prompt Caching in Claude API: Complete 2026 Guide](https://www.aifreeapi.com/en/posts/claude-api-prompt-caching-guide)
- [GitHub Issue #15261: API Error 400 due to tool use concurrency issues](https://github.com/anthropics/claude-code/issues/15261)
