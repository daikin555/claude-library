---
title: "[VSCode] 手動コンパクト後に使用量インジケーターが更新されない問題を修正"
date: 2026-01-13
tags: ['バグ修正', 'VSCode', '使用量', 'UI']
---

## 原文（日本語に翻訳）

[VSCode] 手動コンパクト後に使用量インジケーターが更新されない問題を修正

## 原文（英語）

[VSCode] Fixed usage indicator not updating after manual compact

## 概要

Claude Code v2.1.6 では、VSCode 拡張機能の使用量表示に関する問題が修正されました。以前のバージョンでは、手動でコンテキストをコンパクト（圧縮）した後も、使用量インジケーターが古い値を表示し続け、実際の使用状況が反映されない問題がありました。この修正により、コンパクト後に使用量が正しく更新されるようになりました。

## 基本的な使い方

この修正は自動的に適用され、ユーザー側での設定変更は不要です。

正常な動作:
1. VSCode で Claude Code を使用
2. `/compact` コマンドでコンテキストを圧縮
3. 使用量インジケーターが自動的に更新される

## 実践例

### 修正前の問題（v2.1.5以前）

コンパクト後も使用量が更新されない:

```
# コンパクト前
使用量: 45,000 / 50,000 tokens (90%)
━━━━━━━━━━━━━━━━━━━░░

# /compact を実行
Compacting conversation...
✓ Compacted to 15,000 tokens

# 使用量インジケーター
使用量: 45,000 / 50,000 tokens (90%)  ← 更新されない
━━━━━━━━━━━━━━━━━━━░░

# 実際には15,000トークンなのに、表示は45,000のまま
# リロードするまで正しい値が表示されない
```

### 修正後の動作（v2.1.6以降）

v2.1.6 では、コンパクト後に即座に更新:

```
# コンパクト前
使用量: 45,000 / 50,000 tokens (90%)
━━━━━━━━━━━━━━━━━━━░░

# /compact を実行
Compacting conversation...
✓ Compacted to 15,000 tokens

# 使用量インジケーター（自動更新）
使用量: 15,000 / 50,000 tokens (30%)  ← 正しく更新
━━━━━━░░░░░░░░░░░░░░

# リロード不要で正確な値が表示される
```

### 使用量インジケーターの位置

VSCode での表示場所:

```
VSCode ウィンドウ:
┌─────────────────────────────────┐
│ File  Edit  View  ...           │
├─────────────────────────────────┤
│ Claude Code                     │
│                                 │
│ > How can I help you?           │
│                                 │
├─────────────────────────────────┤
│ 15,000 / 50,000 tokens (30%)    │ ← 使用量表示
│ ━━━━━━░░░░░░░░░░░░░░            │
└─────────────────────────────────┘
```

### コンパクト操作の流れ

使用量が多くなった場合のワークフロー:

```bash
# 1. 使用量を確認
使用量: 48,000 / 50,000 tokens (96%)
警告: コンテキストがほぼ満杯です

# 2. コンパクトを実行
/compact

# 3. 圧縮処理
Analyzing conversation...
Identifying key information...
Compacting...

# 4. 完了
✓ Compacted: 48,000 → 18,000 tokens
  Saved: 30,000 tokens (62% reduction)

# 5. 使用量が更新される
使用量: 18,000 / 50,000 tokens (36%)
# v2.1.6: 即座に反映
# v2.1.5以前: 古い値のまま
```

### 自動コンパクトとの比較

手動コンパクトと自動コンパクト:

```bash
# 手動コンパクト
/compact
# v2.1.6: 使用量が正しく更新される

# 自動コンパクト（閾値到達時）
# 使用量: 90%到達
# → 自動的にコンパクト
# → v2.1.5でも更新されていた

# v2.1.6 の修正は「手動」コンパクトのみに関連
```

### コンパクト前後の比較

詳細な使用量の変化:

```
# コンパクト前
━━━━━━━━━━━━━━━━━━━░░ 96%
Total: 48,000 tokens
├─ Messages: 35,000 tokens
├─ Context: 10,000 tokens
└─ Tools: 3,000 tokens

# コンパクト後
━━━━━━━░░░░░░░░░░░░░░ 36%
Total: 18,000 tokens
├─ Messages: 8,000 tokens (圧縮)
├─ Context: 8,000 tokens (圧縮)
└─ Tools: 2,000 tokens

# v2.1.6: この変化が即座にUIに反映される
```

### VSCode 拡張機能特有の問題

この問題は VSCode 版のみ:

```
# CLI版 Claude Code:
# 元々正しく動作していた

# VSCode 拡張機能:
# v2.1.5以前: 手動コンパクト後に更新されない
# v2.1.6: 修正済み
```

### リロードによる回避策（v2.1.5以前）

修正前の回避方法:

```bash
# v2.1.5以前の回避策

# 1. コンパクトを実行
/compact

# 2. 使用量が更新されない場合
# VSCode をリロード
Ctrl+Shift+P → "Reload Window"

# 3. リロード後、正しい使用量が表示される

# v2.1.6 では不要
```

### 使用量の手動確認

正確な使用量を確認:

```bash
# 統計情報を表示
/stats

# 詳細な使用量情報:
Current Session:
  Messages: 25
  Total tokens: 18,450
  Context window: 50,000
  Usage: 36.9%

# この値とインジケーターが一致する
# v2.1.6: 常に一致
# v2.1.5以前: コンパクト後は不一致の可能性
```

### 複数回のコンパクト

連続してコンパクトを実行:

```bash
# 1回目のコンパクト
/compact
48,000 → 18,000 tokens
使用量: 36% ✓ 更新される

# さらに会話を続ける
...

# 2回目のコンパクト
/compact
42,000 → 20,000 tokens
使用量: 40% ✓ 更新される

# v2.1.6: 毎回正しく更新される
```

### プログレスバーの動作

コンパクト中のプログレス表示:

```
# コンパクト実行中
Compacting...
[████████░░░░░░░░] 50%

# 完了
✓ Compacted

# 使用量が更新される
━━━━━━━░░░░░░░░░░░░░░ 36%

# v2.1.6: アニメーションもスムーズ
```

## 注意点

- この修正は Claude Code v2.1.6 で導入されました
- VSCode 拡張機能版のみの修正です（CLI版は元々正常）
- 手動コンパクト（`/compact`）後に使用量インジケーターが正しく更新されます
- 自動コンパクトは v2.1.5 以前でも正しく動作していました
- リロードせずに正確な使用量が表示されるようになりました
- 使用量インジケーターはステータスバーまたはパネルに表示されます
- この修正により、コンテキスト管理がより直感的になりました

## 関連情報

- [Changelog v2.1.6](https://github.com/anthropics/claude-code/releases/tag/v2.1.6)
- [Claude Code VSCode 拡張機能](https://marketplace.visualstudio.com/items?itemName=Anthropic.claude-code)
- [コンテキスト管理](https://code.claude.com/docs/context-management)
