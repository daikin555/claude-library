---
title: "ãƒ•ãƒƒã‚¯ãƒ–ãƒ­ãƒƒã‚­ãƒ³ã‚°ã‚¨ãƒ©ãƒ¼æ™‚ã®stderrå†…å®¹UIè¡¨ç¤ºã®ä¿®æ­£"
date: 2026-02-13
tags: [bugfix, hooks, stderr, ui, error-display]
---

## åŸæ–‡ï¼ˆæ—¥æœ¬èªï¼‰
ãƒ•ãƒƒã‚¯ãŒãƒ–ãƒ­ãƒƒã‚­ãƒ³ã‚°ã‚¨ãƒ©ãƒ¼ã‚’è¿”ã—ãŸéš›ã«ã€stderrå†…å®¹ãŒUIã«è¡¨ç¤ºã•ã‚Œã‚‹å•é¡Œã‚’ä¿®æ­£ã—ã¾ã—ãŸã€‚

## åŸæ–‡ï¼ˆè‹±èªï¼‰
Fixed hook blocking errors showing stderr content in UI

## æ¦‚è¦
Claude Code v2.1.41ã§ã¯ã€ã‚«ã‚¹ã‚¿ãƒ ãƒ•ãƒƒã‚¯ï¼ˆhooksï¼‰ãŒãƒ–ãƒ­ãƒƒã‚­ãƒ³ã‚°ã‚¨ãƒ©ãƒ¼ï¼ˆçµ‚äº†ã‚³ãƒ¼ãƒ‰2ï¼‰ã‚’è¿”ã—ãŸéš›ã®stderrï¼ˆæ¨™æº–ã‚¨ãƒ©ãƒ¼å‡ºåŠ›ï¼‰ã®è¡¨ç¤ºæ–¹æ³•ãŒä¿®æ­£ã•ã‚Œã¾ã—ãŸã€‚ã“ã®ä¿®æ­£ã«ã‚ˆã‚Šã€ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒé©åˆ‡ã«ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã•ã‚Œã€èª­ã¿ã‚„ã™ãè¡¨ç¤ºã•ã‚Œã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚

## é–¢é€£ã™ã‚‹ä¿®æ­£ã¨ã®é–¢ä¿‚

æœ¬ä¿®æ­£ã¯ã€ä»¥ä¸‹ã®2ã¤ã®é–¢é€£ä¿®æ­£ã¨é€£æºã—ã¦å‹•ä½œã—ã¾ã™ï¼š

1. **2.1.41-hook-blocking-stderr-fix.md**: ãƒ•ãƒƒã‚¯ãƒ–ãƒ­ãƒƒã‚­ãƒ³ã‚°ã‚¨ãƒ©ãƒ¼æ™‚ã«stderrãŒ**è¡¨ç¤ºã•ã‚Œãªã„**å•é¡Œã‚’ä¿®æ­£
2. **æœ¬ä¿®æ­£**: stderrã®**è¡¨ç¤ºæ–¹æ³•**ã‚’æ”¹å–„

ã¤ã¾ã‚Šã€stderrãŒç¢ºå®Ÿã«è¡¨ç¤ºã•ã‚Œã‚‹ã‚ˆã†ã«ãªã£ãŸä¸Šã§ã€ãã®è¡¨ç¤ºæ–¹æ³•ã‚‚æ”¹å–„ã•ã‚Œã¾ã—ãŸã€‚

## å•é¡Œã®è©³ç´°

### ä¿®æ­£å‰ã®å‹•ä½œ
ãƒ•ãƒƒã‚¯ãŒãƒ–ãƒ­ãƒƒã‚­ãƒ³ã‚°ã‚¨ãƒ©ãƒ¼ã‚’è¿”ã—ãŸéš›ã€stderrå†…å®¹ãŒç”Ÿã®ã¾ã¾è¡¨ç¤ºã•ã‚Œã€èª­ã¿ã«ãã„çŠ¶æ…‹ã§ã—ãŸã€‚

```bash
# ä¿®æ­£å‰ã®è¡¨ç¤ºä¾‹
âŒ Operation blocked by hook

Error: Bash tool is not allowed in production environment\nUse safe alternatives or request approval from the team lead\n\nDetails:\n  - Environment: production\n  - Command: rm -rf /tmp/test\n  - Policy: destructive-commands-blocked\n

# æ”¹è¡Œã‚³ãƒ¼ãƒ‰(\n)ãŒãã®ã¾ã¾è¡¨ç¤ºã•ã‚Œã€èª­ã¿ã«ãã„
```

### ä¿®æ­£å¾Œã®å‹•ä½œ
stderrå†…å®¹ãŒé©åˆ‡ã«ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã•ã‚Œã€èª­ã¿ã‚„ã™ãè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚

```bash
# ä¿®æ­£å¾Œã®è¡¨ç¤ºä¾‹
âŒ Operation blocked by hook

Error: Bash tool is not allowed in production environment
Use safe alternatives or request approval from the team lead

Details:
  - Environment: production
  - Command: rm -rf /tmp/test
  - Policy: destructive-commands-blocked

# æ”¹è¡ŒãŒæ­£ã—ãå‡¦ç†ã•ã‚Œã€è¦‹ã‚„ã™ãè¡¨ç¤ºã•ã‚Œã‚‹
```

## åŸºæœ¬çš„ãªä½¿ã„æ–¹

### ãƒ•ãƒƒã‚¯ã®ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä½œæˆ
ä¿®æ­£å¾Œã¯ã€è¤‡æ•°è¡Œã®ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é©åˆ‡ã«è¡¨ç¤ºã§ãã¾ã™ã€‚

```bash
#!/bin/bash
# .claude/hooks/tool-call.sh

if [ "$TOOL_NAME" = "Bash" ]; then
  COMMAND="$2"

  if echo "$COMMAND" | grep -qE "rm -rf"; then
    # è¤‡æ•°è¡Œã®ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
    cat >&2 <<EOF
âš ï¸  SECURITY WARNING: Destructive command detected

Command: $COMMAND
Risk Level: HIGH
Policy: Destructive operations require manual approval

Recommendations:
  1. Verify the target directory
  2. Create a backup first
  3. Use trash/recycle bin instead
  4. Request approval from team lead

To proceed, use the /bypass command or contact security team.
EOF
    exit 2
  fi
fi

exit 0
```

å®Ÿè¡Œæ™‚ã®è¡¨ç¤ºï¼ˆä¿®æ­£å¾Œï¼‰:
```bash
> bash -c "rm -rf /data"

âŒ Operation blocked by hook
âš ï¸  SECURITY WARNING: Destructive command detected

Command: rm -rf /data
Risk Level: HIGH
Policy: Destructive operations require manual approval

Recommendations:
  1. Verify the target directory
  2. Create a backup first
  3. Use trash/recycle bin instead
  4. Request approval from team lead

To proceed, use the /bypass command or contact security team.
```

## å®Ÿè·µä¾‹

### ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒãƒªã‚·ãƒ¼é•åã®è©³ç´°è¡¨ç¤º
ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒãƒªã‚·ãƒ¼ã«é•åã—ãŸéš›ã€è©³ç´°ãªæƒ…å ±ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚

```bash
#!/bin/bash
# .claude/hooks/tool-call.sh

if [ "$TOOL_NAME" = "Write" ]; then
  FILE_PATH="$2"

  if echo "$FILE_PATH" | grep -qE "production\.config|\.env\.prod"; then
    cat >&2 <<EOF
ğŸ”’ PRODUCTION FILE MODIFICATION BLOCKED

File: $FILE_PATH
Reason: Protected production configuration

Security Policy:
  - Production configs require PR review
  - Direct editing is not allowed
  - Changes must go through approval process

Required Actions:
  1. Create a feature branch
  2. Make changes in development environment
  3. Test thoroughly
  4. Create Pull Request
  5. Request review from DevOps team

Emergency Contact:
  - DevOps Lead: ops@company.com
  - Security Team: security@company.com

Override Code: Use '/bypass PROD_OVERRIDE_[ticket-number]'
EOF
    exit 2
  fi
fi

exit 0
```

å®Ÿè¡Œæ™‚ã®è¡¨ç¤ºï¼ˆä¿®æ­£å¾Œï¼‰:
```bash
> "production.configã‚’ç·¨é›†ã—ã¦ãã ã•ã„"

âŒ Operation blocked by hook
ğŸ”’ PRODUCTION FILE MODIFICATION BLOCKED

File: production.config
Reason: Protected production configuration

Security Policy:
  - Production configs require PR review
  - Direct editing is not allowed
  - Changes must go through approval process

Required Actions:
  1. Create a feature branch
  2. Make changes in development environment
  3. Test thoroughly
  4. Create Pull Request
  5. Request review from DevOps team

Emergency Contact:
  - DevOps Lead: ops@company.com
  - Security Team: security@company.com

Override Code: Use '/bypass PROD_OVERRIDE_[ticket-number]'
```

### ã‚³ãƒ³ãƒ—ãƒ©ã‚¤ã‚¢ãƒ³ã‚¹ãƒã‚§ãƒƒã‚¯
ã‚³ãƒ³ãƒ—ãƒ©ã‚¤ã‚¢ãƒ³ã‚¹è¦ä»¶ã«åŸºã¥ããƒã‚§ãƒƒã‚¯ã§ã™ã€‚

```bash
#!/bin/bash
# .claude/hooks/tool-call.sh

if [ "$TOOL_NAME" = "Bash" ] && echo "$2" | grep -q "git commit"; then
  COMMIT_MSG="$3"

  # ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®è¦ä»¶ãƒã‚§ãƒƒã‚¯
  if ! echo "$COMMIT_MSG" | grep -qE "^(feat|fix|docs|refactor|test|chore):"; then
    cat >&2 <<EOF
âŒ COMMIT MESSAGE POLICY VIOLATION

Your commit message does not follow the required format.

Required Format:
  <type>: <description>

Valid Types:
  - feat: New feature
  - fix: Bug fix
  - docs: Documentation changes
  - refactor: Code refactoring
  - test: Test updates
  - chore: Maintenance tasks

Examples:
  âœ“ feat: Add user authentication
  âœ“ fix: Resolve memory leak in parser
  âœ“ docs: Update API documentation
  âœ— Updated code
  âœ— Fixed bug

Your message: "$COMMIT_MSG"

Please rewrite your commit message following the convention.
For more info: https://company.com/git-guidelines
EOF
    exit 2
  fi
fi

exit 0
```

å®Ÿè¡Œæ™‚ã®è¡¨ç¤ºï¼ˆä¿®æ­£å¾Œï¼‰:
```bash
> git commit -m "Updated code"

âŒ Operation blocked by hook
âŒ COMMIT MESSAGE POLICY VIOLATION

Your commit message does not follow the required format.

Required Format:
  <type>: <description>

Valid Types:
  - feat: New feature
  - fix: Bug fix
  - docs: Documentation changes
  - refactor: Code refactoring
  - test: Test updates
  - chore: Maintenance tasks

Examples:
  âœ“ feat: Add user authentication
  âœ“ fix: Resolve memory leak in parser
  âœ“ docs: Update API documentation
  âœ— Updated code
  âœ— Fixed bug

Your message: "Updated code"

Please rewrite your commit message following the convention.
For more info: https://company.com/git-guidelines
```

### ãƒªã‚½ãƒ¼ã‚¹åˆ¶é™ãƒã‚§ãƒƒã‚¯
ã‚·ã‚¹ãƒ†ãƒ ãƒªã‚½ãƒ¼ã‚¹ï¼ˆãƒ‡ã‚£ã‚¹ã‚¯ã€ãƒ¡ãƒ¢ãƒªãªã©ï¼‰ã®åˆ¶é™ãƒã‚§ãƒƒã‚¯ã§ã™ã€‚

```bash
#!/bin/bash
# .claude/hooks/tool-call.sh

if [ "$TOOL_NAME" = "Bash" ]; then
  # ãƒ‡ã‚£ã‚¹ã‚¯ä½¿ç”¨é‡ãƒã‚§ãƒƒã‚¯
  DISK_USAGE=$(df -h / | awk 'NR==2 {print $5}' | sed 's/%//')

  if [ "$DISK_USAGE" -gt 90 ]; then
    cat >&2 <<EOF
âš ï¸  DISK SPACE CRITICAL WARNING

Current disk usage: ${DISK_USAGE}%
Threshold: 90%
Status: CRITICAL

Impact:
  - System performance degraded
  - Risk of operation failure
  - Database writes may fail

Immediate Actions Required:
  1. Check large files: du -sh /* | sort -hr | head -10
  2. Clean temporary files: rm -rf /tmp/*
  3. Remove old logs: find /var/log -mtime +30 -delete
  4. Clear package cache: apt-get clean

For assistance:
  - IT Support: support@company.com
  - Disk quota increase: ops@company.com

Operation blocked until disk usage < 85%
EOF
    exit 2
  fi
fi

exit 0
```

## ã“ã®ä¿®æ­£ã®åˆ©ç‚¹

### å¯èª­æ€§ã®å‘ä¸Š
- æ”¹è¡ŒãŒæ­£ã—ãå‡¦ç†ã•ã‚Œã‚‹
- ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒæ•´å½¢ã•ã‚Œã‚‹
- è¤‡æ•°è¡Œã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒèª­ã¿ã‚„ã™ã„

### ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“ã®æ”¹å–„
- ã‚¨ãƒ©ãƒ¼å†…å®¹ãŒç†è§£ã—ã‚„ã™ã„
- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³é …ç›®ãŒæ˜ç¢º
- æŠ€è¡“çš„è©³ç´°ãŒé©åˆ‡ã«è¡¨ç¤º

### ãƒ‡ãƒãƒƒã‚°ã®å®¹æ˜“åŒ–
- ã‚¨ãƒ©ãƒ¼ã®åŸå› ãŒæ˜ç¢º
- è§£æ±ºç­–ãŒåˆ†ã‹ã‚Šã‚„ã™ãæç¤º
- ãƒ­ã‚°å‡ºåŠ›ã‚‚æ•´å½¢ã•ã‚Œã‚‹

## ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹

### æ§‹é€ åŒ–ã•ã‚ŒãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
```bash
cat >&2 <<EOF
âŒ ERROR_TITLE

Problem: å…·ä½“çš„ãªå•é¡Œã®èª¬æ˜

Details:
  - é …ç›®1: è©³ç´°
  - é …ç›®2: è©³ç´°

Actions Required:
  1. æ‰‹é †1
  2. æ‰‹é †2

Additional Resources:
  - ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ: URL
  - ã‚µãƒãƒ¼ãƒˆ: é€£çµ¡å…ˆ
EOF
```

### è¦–è¦šçš„ãªåŒºåˆ¥
```bash
# çµµæ–‡å­—ã‚’ä½¿ç”¨ï¼ˆä¿®æ­£å¾Œã¯æ­£ã—ãè¡¨ç¤ºã•ã‚Œã‚‹ï¼‰
echo "âŒ Error" >&2
echo "âš ï¸  Warning" >&2
echo "â„¹ï¸  Info" >&2
echo "âœ“ Success" >&2
```

## æ³¨æ„ç‚¹
- stderrå†…å®¹ã¯é©åˆ‡ã«ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—å‡¦ç†ã•ã‚Œã¾ã™
- éå¸¸ã«é•·ã„ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯åˆ‡ã‚Šè©°ã‚ã‚‰ã‚Œã‚‹å ´åˆãŒã‚ã‚Šã¾ã™
- ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã‚·ãƒ¼ã‚±ãƒ³ã‚¹ï¼ˆè‰²ã‚³ãƒ¼ãƒ‰ãªã©ï¼‰ã¯ä¿æŒã•ã‚Œã¾ã™
- ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«æ©Ÿå¯†æƒ…å ±ã‚’å«ã‚ãªã„ã‚ˆã†æ³¨æ„ã—ã¦ãã ã•ã„

## é–¢é€£æƒ…å ±
- [Claude Code Hooks Documentation](https://code.claude.com/docs/en/hooks)
- [Error Handling Best Practices](https://code.claude.com/docs/en/error-handling)
- [Claude Code - How it works](https://code.claude.com/docs/en/how-claude-code-works)
