---
title: "プランモード移行時のクラッシュ問題修正（プロジェクト設定欠損時）"
date: 2026-02-04
tags: [plan-mode, fix, config]
---

# プランモード移行時のクラッシュ問題修正（プロジェクト設定欠損時）

## 原文（日本語に翻訳）
プロジェクト設定ファイル（~/.claude.json）にデフォルトフィールドが欠けている場合に、プランモードに入るとクラッシュしてセッションが使用不可能になる問題を修正しました。

## 原文（英語）
Fixed a crash that made sessions unusable after entering plan mode when project config in `~/.claude.json` was missing default fields

## 概要
`~/.claude.json` ファイルに必要なデフォルトフィールドが欠けている状態でプランモードに移行すると、Claudeがクラッシュしてセッション全体が使用不可能になる深刻な問題が修正されました。この修正により、設定ファイルが不完全な場合でも安全にプランモードを使用できるようになりました。

## 基本的な使い方

### プランモードの正常な利用
```bash
# セッション内でプランモードに移行
claude

> "新しい認証機能を追加したい"

# Claudeが自動的にプランモードに移行
# 以前: ~/.claude.jsonに欠損フィールドがある場合クラッシュ
# 現在: 安全にプランモードが起動
```

### 設定ファイルの確認
```bash
# ~/.claude.jsonファイルの存在確認
cat ~/.claude.json

# 設定ファイルの構造を確認
# 欠損フィールドがあっても自動的に補完される
```

## 実践例

### 複雑な機能追加でのプランモード利用
```bash
> "ユーザー認証システムを追加して。OAuth2.0対応で。"

# Claudeがプランモードに移行
# 1. 要件の分析
# 2. 実装計画の作成
# 3. ユーザー承認を求める

# 以前: ~/.claude.jsonが不完全だとここでクラッシュ
# 現在: 正常にプラン作成が進行
```

### 初回セットアップ後のプランモード利用
新しいマシンでClaude Codeを初めて使う場合：

```bash
# 初回起動
claude

# 設定ファイルが自動生成される
# デフォルトフィールドが自動的に設定される

> "大規模なリファクタリングを計画して"

# 設定ファイルが未完成でもプランモードが正常動作
```

### エラー回復シナリオ
設定ファイルが破損した場合でも復旧可能：

```bash
# Claude Codeは自動バックアップを5世代保持
# ~/.claude.json が破損した場合

# 1. バックアップから復元
ls -la ~/.claude/*.json.backup*

# 2. または、Claude Codeが自動的に修復
claude
# デフォルトフィールドが自動補完される

# プランモードを試す
> "複雑な実装の計画を立てて"
# 正常に動作
```

## 注意点

- **自動バックアップ**: Claude Codeは設定ファイルのタイムスタンプ付きバックアップを自動作成し、最新5世代を保持します。設定が破損した場合はバックアップから復元できます。

- **設定ファイルの場所**: `~/.claude.json` はユーザー設定、MCP サーバー設定、プロジェクトごとの状態（許可されたツール、信頼設定）、キャッシュなどを含みます。

- **手動編集時の注意**: `~/.claude.json` を手動で編集する場合、JSON形式が正しいことを確認してください。不正なJSONはClaudeが自動修復しますが、一時的にデータが失われる可能性があります。

- **バージョンアップ後**: 新しいバージョンにアップグレードした後、初回起動時に設定ファイルが自動的に更新される場合があります。

- **プランモードの推奨用途**: プランモードは、複雑な実装タスク（複数ファイル変更、アーキテクチャ決定、多段階の変更）に適しています。

## 関連情報

- [Claude Code settings - Claude Code Docs](https://code.claude.com/docs/en/settings)
- [Plan Mode | Claude AI Dev](https://claudeai.dev/docs/mechanics/foundation/plan-mode/)
- [GitHub: claude-code-showcase - Comprehensive project configuration example](https://github.com/ChrisWiles/claude-code-showcase)
- [Claude Code Changelog](https://github.com/anthropics/claude-code/blob/main/CHANGELOG.md)
