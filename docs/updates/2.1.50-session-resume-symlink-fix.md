---
title: "シンボリックリンクを含むパスでのセッション再開の不可視バグとSSH切断時のデータ損失を修正しました"
date: 2026-02-21
tags: [bug-fix, session, symlink, ssh]
---

## 原文（日本語に翻訳）

作業ディレクトリにシンボリックリンクが含まれる場合に再開されたセッションが非表示になるバグを修正しました。セッションストレージのパスが起動時の異なるタイミングで解決されていたことが原因です。また、SSH切断時のセッションデータ損失も修正しました。グレースフルシャットダウンシーケンスにおいて、フックとアナリティクスの前にセッションデータをフラッシュするようになりました。

## 原文（英語）

Fixed a bug where resumed sessions could be invisible when the working directory involved symlinks, because the session storage path was resolved at different times during startup. Also fixed session data loss on SSH disconnect by flushing session data before hooks and analytics in the graceful shutdown sequence.

## 概要

このリリースでは2つのセッション関連バグが修正されました。1つ目は、作業ディレクトリにシンボリックリンクが含まれる環境（例: `/home/user` が別パスへのシンボリックリンク）でClaudeを再起動した際に、以前のセッションが「再開可能セッション一覧」に表示されない問題です。2つ目は、SSH接続が突然切断された際にセッションデータが保存されずに失われる問題です。

## 基本的な使い方

この修正は自動的に適用されます。特別な設定は不要です。シンボリックリンクを含むディレクトリでClaudeを使用する場合でも、セッションの再開が正常に機能します。

```bash
# シンボリックリンクを含むパスでの作業例
ls -la /home/user
# lrwxrwxrwx 1 root root 10 Feb 21 2026 /home/user -> /data/users/user

# このようなパスでもセッションが正しく保存・再開される
claude
# セッション作業後に終了

claude
# 以前のセッションが「再開可能」として正常に表示される
```

## 実践例

### ユースケース1: シンボリックリンクを使ったプロジェクト構成での再開

プロジェクトディレクトリがシンボリックリンクになっている場合。

```bash
# プロジェクトがシンボリックリンク
ls -la ~/projects/myapp
# lrwxrwxrwx 1 user user 30 Feb 21 2026 /home/user/projects/myapp -> /mnt/data/projects/myapp

cd ~/projects/myapp
claude
# ... 作業 ...
# Ctrl+C で終了

# 次回起動時に正常に再開できる
claude --resume
```

### ユースケース2: SSH経由での開発でのセッション保全

リモートサーバーにSSHで接続してClaudeを使用する場合、ネットワーク切断が発生しても作業内容が保存されます。

```bash
# リモートサーバーにSSH接続
ssh user@remote-server

# Claudeを起動して作業
claude
# ... 長時間の作業 ...
# ネットワーク切断が発生 → セッションデータが保護される

# 再接続後にセッションを再開
ssh user@remote-server
claude --resume
# 切断前の作業が復元される
```

### ユースケース3: Docker/WSL環境でのシンボリックリンク対応

DockerコンテナやWSL環境ではホームディレクトリがシンボリックリンクになっていることがあります。

```bash
# WSL環境でのパス確認
realpath ~
# /mnt/wsl/instances/Ubuntu-22.04/root

ls -la /root
# 実際にはシンボリックリンクの可能性がある

# このような環境でもセッション再開が正常に動作
claude
```

## 注意点

- この修正はv2.1.50以降で自動的に有効になります。
- シンボリックリンクの問題は特に `realpath` で解決されるパスと元のシンボリックリンクパスが異なる場合に発生していました。
- SSH切断の保護は「グレースフルシャットダウン」が発生した場合（SIGTERMシグナルなど）に適用されます。強制終了（SIGKILLなど）では完全な保護が難しい場合があります。
- セッションデータの保存場所が変わったわけではありません。保存タイミングの問題が修正されました。

## 関連情報

- [Claude Code 公式ドキュメント](https://docs.anthropic.com/ja/docs/claude-code/overview)
- [Claude Code CHANGELOG](https://github.com/anthropics/claude-code/blob/main/CHANGELOG.md)
- [セッション管理について](https://docs.anthropic.com/ja/docs/claude-code/memory)
