---
title: "PDFを多数含む会話でのコンパクション失敗バグ修正"
date: 2026-02-19
tags: [bug-fix, compaction, pdf, memory]
---

## 原文（日本語に翻訳）

コンパクション API に送信する前に画像と同様にドキュメントブロックも除去することで、会話に多数の PDF ドキュメントが含まれる場合にコンパクションが失敗する問題を修正しました（anthropics/claude-code#26188）。

## 原文（英語）
Fixed compaction failing when conversation contains many PDF documents by stripping document blocks alongside images before sending to the compaction API (anthropics/claude-code#26188)

## 概要

長い会話セッションでコンテキストが大きくなった際に実行されるコンパクション処理が、会話中に多数のPDFドキュメントが含まれる場合に失敗する問題がありました。画像ブロックと同様にドキュメントブロックもコンパクションAPI送信前に除去するよう修正され、PDFを多用するワークフローでも安定した動作が保証されるようになりました。

## 基本的な使い方

```bash
# PDFを含む長い会話セッションでも安定して動作
# コンパクションはコンテキストが大きくなった際に自動的に実行される

claude "この複数のPDFファイルを分析してください"
# PDFをいくつかアップロードして会話を続ける

# 修正前: 多数のPDFがある場合にコンパクション時にエラーが発生
# 修正後: コンパクションが正常に完了し、会話を継続できる
```

## 実践例

### ユースケース1: 複数のPDFドキュメントの分析

```bash
# 複数の技術仕様書PDFを参照しながら作業する場合
claude "以下のPDF仕様書をもとにコードを実装してください"
# PDF1: API仕様書
# PDF2: データモデル仕様書
# PDF3: セキュリティ要件書
# PDF4: UIデザインガイドライン

# 長時間の会話でコンパクションが実行されても継続できる
```

### ユースケース2: 研究論文の比較分析

```bash
# 複数の学術論文PDFを会話に含める場合
claude "これらの研究論文を比較して要点をまとめてください"
# 論文1〜10をアップロードして分析

# コンパクション後も会話コンテキストが維持される
# 大量のPDFを扱う長時間セッションが安定する
```

### ユースケース3: ドキュメント処理ワークフロー

```bash
# 契約書や法律文書など複数PDFを処理するワークフロー
claude "これらの契約書の重要条項を抽出してください"

# ポイント: コンパクションが自動的に実行されても
# PDFの内容に基づいた会話が継続できる
# エラーで中断されることなく作業を完了できる
```

## 注意点

- コンパクションはコンテキストウィンドウが満杯になりそうな場合に自動的に実行されます
- コンパクション時にPDFドキュメントブロックは除去されますが、これはAPIの制限によるものです
- コンパクション後は以前のPDFの内容を直接参照する能力が低下する場合があります
- 多数のPDFを扱う場合は、重要な情報を早めにテキストとして抽出しておくことを推奨します
- GitHub Issue #26188 で報告された問題の修正です

## 関連情報

- [Claude Code 公式ドキュメント](https://docs.anthropic.com/ja/docs/claude-code/overview)
- [Claude Code CHANGELOG](https://github.com/anthropics/claude-code/blob/main/CHANGELOG.md)
- [GitHub Issue #26188](https://github.com/anthropics/claude-code/issues/26188)
