---
title: "Vertex/Bedrockでのstructured-outputsベータヘッダー送信の修正"
date: 2026-02-12
tags: [bug-fix, structured-outputs, bedrock, vertex, api]
---

## 原文（日本語）
Vertex/Bedrockでstructured-outputsベータヘッダーが無条件に送信されていた問題を修正しました。

## 原文（英語）
Fixed structured-outputs beta header being sent unconditionally on Vertex/Bedrock

## 概要
AWS BedrockおよびGoogle Cloud Vertex AIを使用している場合に、structured-outputs機能のベータヘッダーが必要ない場合でも無条件に送信されていた問題が修正されました。これにより、API呼び出しが適切に処理され、不要なヘッダーによるエラーや警告が発生しなくなりました。

## 基本的な使い方

この修正は自動的に適用されるため、特別な操作は不要です。

```bash
# BedrockまたはVertexを使用している場合
claude --provider bedrock
claude --provider vertex

# 修正により、適切なヘッダーのみが送信される
```

## 実践例

### AWS Bedrockでの構造化出力
```bash
# Bedrockを使用してAPIリクエスト
export CLAUDE_PROVIDER=bedrock

claude "ユーザーデータをJSON形式で生成してください"

# 修正前: 不要なstructured-outputsベータヘッダーが送信される
#         → 場合によってはエラーや警告が発生
# 修正後: 必要なヘッダーのみが送信される
#         → 正常に処理される
```

### Google Cloud Vertex AIでの使用
```bash
# Vertex AIを使用してプロジェクトを実行
claude --provider vertex

# 構造化出力が必要な場合のみ適切なヘッダーが送信される
# 不要なベータ機能のヘッダーは送信されない
```

### マルチプロバイダー環境での開発
```bash
# 開発環境: Anthropic API（structured-outputs対応）
claude --profile dev
# → structured-outputsヘッダーが適切に送信される

# 本番環境: AWS Bedrock
claude --profile prod --provider bedrock
# → Bedrock固有の設定が適用され、不要なヘッダーは送信されない
```

### CI/CD環境での自動化
```bash
# GitLab CI/CD with Bedrock
script:
  - export CLAUDE_PROVIDER=bedrock
  - claude "コードレビューを実行"

# 修正により、Bedrock環境で安定して動作
# 不要なベータヘッダーによるエラーが発生しない
```

## 注意点

- この修正はヘッダー送信のロジックのみに影響し、structured-outputs機能自体の動作は変更しません
- Anthropic APIを直接使用している場合は、この修正の影響を受けません
- 各プロバイダーで対応している機能は異なるため、ドキュメントで確認してください
- structured-outputs機能を使用する場合は、プロバイダーがサポートしているか確認が必要です

## 関連情報

- [AWS Bedrock - API リファレンス](https://docs.aws.amazon.com/bedrock/latest/APIReference/)
- [Google Cloud Vertex AI - Claude API](https://cloud.google.com/vertex-ai/docs/generative-ai/model-reference/anthropic-claude)
- [Anthropic API - Structured Outputs](https://docs.anthropic.com/claude/reference/structured-outputs)
- [Claude Code - プロバイダー設定](https://docs.claude.com/claude-code/configuration/providers)
