---
title: "履歴再生時の貼り付けコンテンツ消失バグを修正"
date: 2026-01-31
tags: ['バグ修正', 'UX', '履歴']
---

## 原文（日本語に翻訳）

上矢印キーまたはCtrl+R検索を使用して履歴からプロンプトを再生する際に、貼り付けられたコンテンツが失われる問題を修正しました

## 原文（英語）

Fixed pasted content being lost when replaying prompts from history using up arrow or Ctrl+R search

## 概要

Claude Code v2.1.0で修正された、履歴機能に関するバグです。以前のバージョンでは、上矢印キー（↑）またはCtrl+R検索を使用してコマンド履歴からプロンプトを呼び出した際に、元々貼り付けられていたテキストやコードが失われる問題がありました。この修正により、履歴からプロンプトを再生しても、貼り付けコンテンツを含むすべての内容が正しく復元されるようになりました。

## 修正前の問題

### 貼り付けたコードが消える

```bash
claude

# 1. 長いコードスニペットを貼り付けて質問
> [大量のコードを貼り付け]
> このコードを最適化してください

# 2. 別のタスクを実行
> 別のファイルを確認

# 3. 上矢印で履歴を遡る
# ↑ キーを押す

# 問題: 貼り付けたコードが消失
# 表示されるのは "このコードを最適化してください" のテキストのみ
# 貼り付けた大量のコードは復元されない
```

### Ctrl+R検索での内容消失

```bash
# 1. エラーメッセージを貼り付けて質問
> [長いエラースタックトレースを貼り付け]
> このエラーを解決してください

# 2. しばらく作業後、同じエラーを再度確認したい
# Ctrl+R を押して "エラーを解決" で検索

# 問題: 検索でプロンプトは見つかるが、
# エラースタックトレースは復元されない
```

## 修正後の動作

### 貼り付けコンテンツの完全な復元

```bash
claude

# 1. コードを貼り付けて質問
> [コードスニペット 50行]
> このコードをリファクタリングしてください

# 2. 別の作業
> 他のタスク

# 3. 上矢印で履歴を遡る
# ↑ キーを押す

# 修正後: 貼り付けた50行のコードも完全に復元される
# テキストとコードの両方が正しく表示される
```

### Ctrl+R検索での完全な復元

```bash
# 1. ログを貼り付けて分析依頼
> [100行のログファイル]
> このログからエラーを特定してください

# 2. Ctrl+R で検索
# Ctrl+R を押して "ログからエラー" で検索

# 修正後: プロンプトとログファイル全体が復元される
```

## 実践例

### デバッグセッションでのエラー再確認

```bash
# 初回: エラーメッセージを貼り付けて質問
> [エラースタックトレース]
> このエラーの原因を教えてください
# 解決策を実施

# しばらく後、同じエラーが再発
# ↑ キーで履歴を遡る
# ✓ エラースタックトレース全体が復元される
# 前回の解決策と比較できる
```

### コードレビューの繰り返し

```bash
# 長いコードブロックをレビュー
> [200行のコードを貼り付け]
> このコードの問題点を指摘してください
# レビュー結果を受け取る

# 修正後、再度同じコードでレビュー
# ↑ キーで元のプロンプトを呼び出す
# ✓ 200行のコード全体が復元される
# 修正箇所を比較しながら再レビュー可能
```

### ドキュメント作成の反復

```bash
# ドキュメント草稿を貼り付けて改善依頼
> [長いマークダウンドキュメント]
> この文書をより分かりやすく書き直してください
# 改善案を受け取る

# 別のアプローチを試したい
# Ctrl+R で "文書をより分かりやすく" 検索
# ✓ 元のドキュメント全体が復元される
# 異なる改善案をリクエストできる
```

## 注意点

- この修正は Claude Code v2.1.0（2026年1月7日リリース）で実装されました
- **v2.1.0未満のバージョンではこの問題が発生します**
- 履歴の呼び出し方法:
  - **↑（上矢印キー）**: 直前のコマンドから順に遡る
  - **Ctrl+R**: インクリメンタル検索で履歴を検索
- 貼り付けコンテンツだけでなく、画像の添付も含めて復元されます（後のバージョンで改善）
- 関連する別のバグも修正されています:
  - プロンプトスタッシュ（Ctrl+S）と復元時の貼り付けテキスト消失も修正
  - キューに入れられたプロンプトの画像が消失する問題も修正
- 履歴は `~/.claude/history` に保存され、セッションをまたいで永続化されます

## 関連情報

- [Claude Code's hidden conversation history](https://kentgigger.com/posts/claude-code-conversation-history)
- [Claude Code Changelog](https://github.com/anthropics/claude-code/blob/main/CHANGELOG.md)
- [Interactive mode - Claude Code Docs](https://code.claude.com/docs/en/interactive-mode)
