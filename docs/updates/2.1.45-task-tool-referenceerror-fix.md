---
title: "Task ツール（バックグラウンドエージェント）完了時の ReferenceError クラッシュ修正"
date: 2026-02-17
tags: [bugfix, task-tool, background-agents, crash, referenceerror]
---

## 原文（日本語に翻訳）

完了時に `ReferenceError` でクラッシュしていた Task ツール（バックグラウンドエージェント）の問題を修正（anthropics/claude-code#22087）

## 原文（英語）

Fixed Task tool (backgrounded agents) crashing with a `ReferenceError` on completion (anthropics/claude-code#22087)

## 概要

Claude Code の Task ツール（バックグラウンドで実行されるエージェント）が、タスク完了時に `ReferenceError` でクラッシュするバグが修正されました。このバグは、バックグラウンドエージェントが正常に処理を終えた際に発生しており、タスクの結果が正しく受け取れない場合がありました。2.1.45 ではこの問題が解決され、バックグラウンドエージェントが安定して完了できるようになります。

## 基本的な使い方

この修正はバグフィックスです。Claude Code を 2.1.45 以上にアップデートするだけで適用されます。Task ツールの使い方自体に変更はありません。

```bash
# Claude Code をアップデート
npm update -g @anthropic-ai/claude-code
```

Task ツールの基本的な使い方（変更なし）：

```
# Claude Code でバックグラウンドタスクを実行
> 大きなリファクタリングを行いたい。まず依存関係の分析を並行して実行してください
```

## 実践例

### バックグラウンドエージェントを使ったコード分析

Task ツールを使うとバックグラウンドで複数の処理を並行実行できます。この修正以前は完了時にクラッシュすることがありましたが、2.1.45 以降は安定して動作します。

```
# プロンプト例
> プロジェクト全体のセキュリティ脆弱性を分析してください。
  バックグラウンドエージェントを使って、
  1. 依存関係のセキュリティスキャン
  2. コードの静的解析
  3. APIエンドポイントのレビュー
  を並行して実行してください。
```

### SDK からの Task ツール利用

プログラムから Task ツールを使う場合も、クラッシュなく完了できるようになりました：

```typescript
import { query } from '@anthropic-ai/claude-code';

async function runBackgroundTask() {
  for await (const message of query({
    prompt: 'テストを並行して実行してください。Task ツールを使って高速化してください。',
    abortController: new AbortController(),
  })) {
    if (message.type === 'text') {
      console.log(message.text);
    }
    // 修正前: タスク完了時に ReferenceError が発生することがあった
    // 修正後: 正常に完了する
  }
}

runBackgroundTask();
```

## 注意点

- このバグは Task ツールを使ってバックグラウンドエージェントを起動した場合に限り発生していました。
- 通常の（バックグラウンドでない）処理では影響がありませんでした。
- クラッシュが起きた場合、タスクの結果（生成されたファイルなど）が部分的に保存されている場合と、失われている場合がありました。
- 2.1.45 へのアップデートで自動的に修正されます。

## 関連情報

- [GitHub Issue #22087](https://github.com/anthropics/claude-code/issues/22087)
- [Claude Code Task ツールドキュメント](https://docs.anthropic.com/ja/docs/claude-code/agent-sdk)
- [Claude Code バックグラウンドエージェント](https://docs.anthropic.com/ja/docs/claude-code/background-tasks)
