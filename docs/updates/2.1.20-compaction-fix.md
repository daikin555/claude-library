---
title: "セッション圧縮時の履歴読み込み問題の修正"
date: 2026-01-27
tags: [bugfix, compaction, resume, session]
---

## 原文（日本語訳）
セッション圧縮の問題が修正され、再開時に圧縮されたサマリーではなく完全な履歴が読み込まれることがなくなりました

## 原文（英語）
Fixed session compaction issues that could cause resume to load full history instead of the compact summary

## 概要
セッションを再開（`--resume` や `--continue`）する際、圧縮されたサマリーではなく完全な履歴が読み込まれてしまう問題が修正されました。これにより、長いセッションでも効率的に作業を再開できます。

## 問題の背景

### 修正前の問題
- セッション圧縮（`/compact` または自動圧縮）後にセッションを再開すると、圧縮されたサマリーではなく完全な会話履歴が読み込まれた
- 結果として、コンテキストウィンドウが不必要に消費された
- 起動時間が長くなった

### 修正後
- 圧縮されたサマリーが正しく読み込まれる
- コンテキストを効率的に使用できる
- セッション再開が高速化

## 基本的な使い方

特別な操作は不要です。通常通りセッションを圧縮・再開するだけで、修正の恩恵を受けられます。

```bash
# セッションを圧縮
claude
> /compact

# 後でセッションを再開
claude --continue
# または
claude --resume
```

## 実践例

### 長期プロジェクトでの作業

```bash
# 1日目: 長いセッションを開始
claude
> プロジェクトのリファクタリングを開始します
# ... 多くのやり取り ...

# コンテキストが80%に達したら手動で圧縮
> /compact

# セッション終了
# Ctrl+C

# 2日目: セッションを再開
claude --continue
# ✅ 圧縮されたサマリーのみが読み込まれる
# ✅ 高速に起動
# ✅ コンテキストに余裕がある
```

### 自動圧縮との連携

```bash
claude
> 大規模なコードベースの分析を実行して
# ... 長時間の作業 ...

# コンテキストが80%を超えると自動圧縮が実行される
# "Auto-compacting conversation..." と表示

# 後日、再開
claude --resume
# ✅ 自動圧縮されたサマリーが正しく読み込まれる
```

### 名前付きセッションでの再開

```bash
# セッションに名前を付ける
claude
> /rename feature-implementation

# 圧縮して終了
> /compact
# Ctrl+C

# 名前で再開
claude --resume feature-implementation
# ✅ 圧縮されたサマリーから再開
```

## セッション圧縮の仕組み

### 圧縮前
```
会話履歴:
[User]: タスク1を実行して
[Assistant]: (詳細な実装...)
[User]: タスク2を実行して
[Assistant]: (詳細な実装...)
[User]: タスク3を実行して
[Assistant]: (詳細な実装...)
...
総トークン数: 50,000
```

### 圧縮後
```
サマリー:
- タスク1: 完了（ユーザー認証実装）
- タスク2: 完了（データベースマイグレーション）
- タスク3: 完了（APIエンドポイント作成）
+ 現在の状態と次のステップ
総トークン数: 2,000
```

### 修正前の問題（再開時）
```
❌ 完全な履歴（50,000トークン）が読み込まれる
→ コンテキストを圧迫
→ 起動が遅い
```

### 修正後（再開時）
```
✅ サマリー（2,000トークン）のみが読み込まれる
→ コンテキストに余裕
→ 高速起動
```

## 圧縮の確認方法

### コンテキスト使用量の確認

```bash
claude
> /context
# 圧縮前後のトークン数を比較
```

### ステータスラインでの確認

```bash
# 画面下部のステータスラインを確認
# [main] 2.3K tokens | claude-sonnet-4-5
#        ^^^^^^^ この数値が圧縮後に減少する
```

## 注意点

- **圧縮のタイミング**: 自動圧縮は約80%に達すると実行されます
- **手動圧縮**: `/compact` で任意のタイミングで圧縮可能
- **情報の損失**: 圧縮により詳細なやり取りの一部は要約されます
- **重要な情報**: 圧縮時に重要な情報が保持されるよう、明示的に記録することを推奨

## パフォーマンスへの影響

### 起動時間の改善

```bash
# 修正前:
# 完全な履歴（50,000トークン）読み込み: 約5-10秒

# 修正後:
# サマリー（2,000トークン）読み込み: 約1-2秒
```

### メモリ使用量の削減

```bash
# 修正前:
# メモリ使用量: 高い（完全な履歴を保持）

# 修正後:
# メモリ使用量: 大幅に削減
```

## トラブルシューティング

### セッションが正しく再開されない場合

```bash
# セッション一覧を確認
claude --resume
# リストから選択して再開
```

### 圧縮が機能しているか確認

```bash
claude
> /context
# "Compacted" または "Compressed" の表示を確認
```

## 関連コマンド

### 手動圧縮
```bash
> /compact
```

### セッション再開
```bash
claude --continue  # 最後のセッションを再開
claude --resume    # セッションを選択して再開
```

### コンテキスト確認
```bash
> /context
```

## 関連情報

- [How Claude Code Works - Compaction](https://code.claude.com/docs/en/how-claude-code-works)
- [Claude Code Session Management](https://stevekinney.com/courses/ai-development/claude-code-session-management)
- [Compact Conversations in Claude Code](https://m.academy/lessons/compact-conversations-claude-code/)
