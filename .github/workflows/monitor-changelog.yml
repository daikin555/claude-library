name: Monitor Changelog & Generate Guide

on:
  schedule:
    # 毎日22:00 UTC（JST 07:00）に実行
    - cron: '0 22 * * *'
  workflow_dispatch:

permissions:
  contents: write
  id-token: write

jobs:
  check-changelog:
    runs-on: ubuntu-latest
    outputs:
      has_changes: ${{ steps.detect.outputs.has_changes }}
    steps:
      - uses: actions/checkout@v4

      - name: Detect changelog changes
        id: detect
        run: |
          if bash scripts/detect-changes.sh; then
            echo "has_changes=true" >> "$GITHUB_OUTPUT"
          else
            echo "has_changes=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Upload new entries
        if: steps.detect.outputs.has_changes == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: new-entries
          path: |
            data/new-entries.md
            data/current-changelog.md

  generate-guide:
    needs: check-changelog
    if: needs.check-changelog.outputs.has_changes == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download new entries
        uses: actions/download-artifact@v4
        with:
          name: new-entries
          path: data/

      - name: Get today's date
        id: date
        run: echo "today=$(date +%Y-%m-%d)" >> "$GITHUB_OUTPUT"

      - name: Generate guide with Claude Code
        env:
          TODAY_DATE: ${{ steps.date.outputs.today }}
        uses: anthropics/claude-code-action@v1
        with:
          prompt: |
            data/new-entries.md ファイルを読み取り、Claude Codeの新しいchangelogエントリを分析して活用ガイド記事を生成してください。

            ## 重要な情報:
            - **今日の日付**: 環境変数 $TODAY_DATE の値（今日の日付: $TODAY_DATE）
            - **changelogからバージョン番号を抽出**: changelogの冒頭に記載されているバージョン番号（例: `## 2.1.30`）を特定してください
            - **ファイル名にはバージョン番号を使用**: `VERSION-feature-name.md` 形式（例: `2.1.30-debug-command.md`）
            - **frontmatter dateフィールドには今日の日付を使用**: YYYY-MM-DD 形式（例: 2026-02-01）

            ## 作業指示:
            1. data/new-entries.md を読み取り、changelogのバージョン番号を特定してください
               - changelogの先頭に `## X.Y.Z` の形式で記載されています
            2. 各主要な変更・新機能について、`docs/updates/` 以下にMarkdownガイド記事を作成してください
            3. **ファイル名**: `VERSION-feature-name.md` 形式にしてください
               - VERSION: changelogから抽出したバージョン番号（例: 2.1.30）
               - feature-name: 機能を表すkebab-case（例: debug-command）
               - 例: "2.1.30-debug-command.md"
            4. 記事は以下のfrontmatter形式で始めてください:
               ```yaml
               ---
               title: "記事タイトル"
               date: $TODAY_DATE  # ← 環境変数の日付を使用（YYYY-MM-DD形式）
               tags: [関連タグ]
               ---
               ```
            5. frontmatterの作成後、dateフィールドが正しいYYYY-MM-DD形式になっているか確認してください
            6. 記事の内容には以下を含めてください:
               - 機能の概要（2-3文）
               - 具体的な使い方・コマンド例
               - 実践的な活用シーン
               - 注意点やTips
            7. すべて日本語で記述してください
            8. 変更をコミットしてください

          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          claude_args: "--allowedTools Edit,Write,\"Bash(git commit:*)\",\"Bash(git add:*)\",Read,Glob,WebSearch,WebFetch"

      - name: Update last-known changelog
        run: |
          cp data/current-changelog.md data/last-known-changelog.md
          git add data/last-known-changelog.md
          git diff --cached --quiet || git commit -m "Update last-known changelog"

      - name: Push changes
        run: |
          git remote set-url origin "https://x-access-token:${PAT_TOKEN}@github.com/${{ github.repository }}.git"
          git push
        env:
          PAT_TOKEN: ${{ secrets.PAT_TOKEN }}
